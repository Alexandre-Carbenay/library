name: Continuous Delivery pipeline for shared libraries
on:
  push:
    branches:
      - 'main'
    paths:
      - 'libs/**'
      - '.github/workflows/cd-libraries.yml'
      - '!**/README.md'
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    branches:
      - 'main'
    paths:
      - 'libs/**'
      - '.github/workflows/cd-libraries.yml'
      - '!**/README.md'
  workflow_dispatch:

jobs:
  build:
    name: 'ğŸ“¦ Build'
    runs-on: [ubuntu-latest]
    permissions:
      id-token: write
      pull-requests: write
      packages: write
      contents: write
    concurrency:
      group: "${{ github.workflow }}-${{ github.ref }}"
      cancel-in-progress: true
    steps:
      - name: "ğŸ“¥ Checkout project sources"
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: "0"

      - name: "ğŸ˜ ğŸ§ª Gradle Wrapper Validation Action"
        uses: gradle/actions/wrapper-validation@v5

      - name: "â˜• ğŸ› ï¸ Set up JDK 21"
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: "ğŸ˜ ğŸ› ï¸ Setup Gradle"
        uses: gradle/actions/setup-gradle@v5

      - name: "ğŸ˜ ğŸ”¨ Compile with Gradle"
        working-directory: ./libs/rest-api-support
        run: make build-compile
        timeout-minutes: 1

      - name: "ğŸ˜ ğŸ§ª Test with Gradle"
        working-directory: ./libs/rest-api-support
        run: make build-test
        timeout-minutes: 2

      - name: "ğŸ§ª ğŸ“’ Publish Tests Report"
        working-directory: ./libs/rest-api-support
        run: make build-test-publish
        timeout-minutes: 1

      - name: "ğŸ˜ ğŸ“¦ Build artifact with Gradle"
        working-directory: ./libs/rest-api-support
        run: make build-jar
        timeout-minutes: 1

      - name: "ğŸ· ğŸ“¦ Define next version based on semantic versioning"
        id: svu
        run: |
          set +e
          mkdir -p target_dir
          wget -q https://github.com/caarlos0/svu/releases/download/v3.1.0/svu_3.1.0_linux_amd64.tar.gz -P target_dir
          cd target_dir || exit
          tar -xzvf svu_3.1.0_linux_amd64.tar.gz
          chmod +x svu
          sudo mv svu /usr/local/bin/
          cd .. || exit
          rm -rf target_dir

          next_tag=$(svu next --tag.prefix="rest-api-support-v" --tag.pattern="rest-api-support-v[0-9]*.[0-9]*.[0-9]*" --log.directory="libs/rest-api-support")
          echo "next_version=${next_tag#"rest-api-support-v"}" >> $GITHUB_OUTPUT

      - name: "ğŸ˜ ğŸ“¦ ğŸš€ Publish artifact with Maven (PR)"
        working-directory: ./libs/rest-api-support
        run: ./gradlew -Pversion=${{ steps.svu.outputs.next_version }}-SNAPSHOT publish
        if: github.ref != 'refs/heads/main' && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ˜ ğŸ“¦ ğŸš€ Publish artifact with Maven (main)"
        working-directory: ./libs/rest-api-support
        run: ./gradlew -Pversion=${{ steps.svu.outputs.next_version }} publish
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: 'ğŸš€ Release'
    runs-on: [ ubuntu-latest ]
    needs: [ build ]
    if: ${{ ! failure() && ! cancelled() && github.ref == 'refs/heads/main' }}
    permissions:
      id-token: write
      packages: write
      contents: write
    steps:
      - name: "ğŸ“¥ Checkout project sources"
        uses: actions/checkout@v6
        with:
          fetch-depth: "0"

      - name: "ğŸ· ğŸ“¦ Define tags based on semantic versioning"
        id: svu
        run: |
          set +e
          mkdir -p target_dir
          wget -q https://github.com/caarlos0/svu/releases/download/v3.1.0/svu_3.1.0_linux_amd64.tar.gz -P target_dir
          cd target_dir || exit
          tar -xzvf svu_3.1.0_linux_amd64.tar.gz
          chmod +x svu
          sudo mv svu /usr/local/bin/
          cd .. || exit
          rm -rf target_dir

          echo "current_tag=$(svu current --tag.prefix="rest-api-support-v" --tag.pattern="rest-api-support-v[0-9]*.[0-9]*.[0-9]*-build-*")" >> $GITHUB_OUTPUT
          echo "next_tag=$(svu next --tag.prefix="rest-api-support-v" --tag.pattern="rest-api-support-v[0-9]*.[0-9]*.[0-9]*" --log.directory="libs/rest-api-support")" >> $GITHUB_OUTPUT
          echo "next_build_tag=$(svu next --tag.prefix="rest-api-support-v" --tag.pattern="rest-api-support-v[0-9]*.[0-9]*.[0-9]*" --log.directory="libs/rest-api-support")-build-${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: "ğŸ· ğŸŒµ Tag Git branch"
        run: |
          git config --global --add safe.directory "$(realpath "./libs/rest-api-support")"
          git config --global user.email "username@users.noreply.github.com"
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global http.sslVerify true

          git -C ./libs/rest-api-support tag -fa ${{ steps.svu.outputs.next_tag }} ${{ github.sha }} -m "${TAG_MSG}"
          git -C ./libs/rest-api-support push --force origin ${{ steps.svu.outputs.next_tag }} --push-option "ci.skip"

          git -C ./libs/rest-api-support tag -fa ${{ steps.svu.outputs.next_build_tag }} ${{ github.sha }} -m "${TAG_MSG}"
          git -C ./libs/rest-api-support push origin ${{ steps.svu.outputs.next_build_tag }} --push-option "ci.skip"

      - name: "ğŸ“¦ ğŸš€ Create Github release"
        run: |
          gh release create ${{ steps.svu.outputs.next_build_tag }} \
            --generate-notes \
            --latest \
            --verify-tag=true \
            --target=main \
            --notes-start-tag=${{ steps.svu.outputs.current_tag }} \
            --prerelease=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
